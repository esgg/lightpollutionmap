<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
    <style>
      .map {
        float: left;
        padding: 10px 10px;
        height:500px;
        width: 1200px;
      }
      .tooltip-inner {
        white-space: nowrap;
      }
      .rotate-north {
        top: 65px;
        left: .5em;
      }
      .ol-touch .rotate-north {
        top: 80px;
      }
      .custom-control {
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        cursor:pointer;
        background: no-repeat url('assets/icons/moon-and-stars.png')
      }
      .night-layer-disable{filter:opacity(.4);cursor:pointer}
      .night-layer-enable{filter:opacity(1);cursor:crosshair}

      .custom-control:hover {filter: opacity(.7)}

      .popover-content{
        background-color: white;
        width:350px;
      }

    </style>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="assets/js/palette.js"></script>
    <title>OpenLayers example</title>
  </head>
  <body>
    <h2>My Map</h2>
    <div id="map" class="map"><div id="popup"></div></div>
    <div>Icons made by <a href="https://www.freepik.com/?__hstc=57440181.341bf4a8c44f38f213cd9e6d1fbe4c38.1556627788500.1556627788500.1556627788500.1&__hssc=57440181.2.1556627788501&__hsfp=3487124377" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" 			    title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" 			    title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
    <script type="text/javascript">

    var iconStyle = new ol.style.Style({
       image: new ol.style.Icon(/** @type {module:ol/style/Icon~Options} */ ({
         anchor: [0.5, 46],
         anchorXUnits: 'fraction',
         anchorYUnits: 'pixels',
         src: 'assets/icons/icon.png'
       }))
     });

      var iconFeature = new ol.Feature(new ol.geom.Point([0, 0]));
      iconFeature.setStyle(iconStyle);

      var sourceViirs = new ol.source.WMTS({
          urls: [
              "https://map1a.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
              "https://map1b.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
              "https://map1c.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",
          ],
          layer: "VIIRS_CityLights_2012",
          format: "image/jpeg",
          matrixSet: "EPSG4326_500m",
          tileGrid: new ol.tilegrid.WMTS({
              origin: [-180, 90],
              resolutions: [
                  0.5625,
                  0.28125,
                  0.140625,
                  0.0703125,
                  0.03515625,
                  0.017578125,
                  0.0087890625,
                  0.00439453125,
                  0.002197265625
              ],
              matrixIds: [0, 1, 2, 3, 4, 5, 6, 7, 8],
              tileSize: 512
          })
      });
      var viirs = new ol.layer.Tile({source: sourceViirs, visible:false});

      var osm = new ol.layer.Tile({
        source: new ol.source.OSM(),
      });


      var tess = new ol.layer.Vector({
        style: function(feature) {
              return feature.get('style');
            },
        source: new ol.source.Vector({features: [iconFeature]})
      });

      var container = document.getElementById('map');

      var radius = 75;

      var showTessLayerControl = function(opt_options) {
        var element = document.createElement('div');
        element.className = 'custom-control night-layer-disable ol-unselectable ol-control';
        ol.control.Control.call(this, {
          element: element
        });
        element.addEventListener('click', function (evt){
          if (element.classList.contains("night-layer-enable")){
            element.classList.remove("night-layer-enable")
            element.classList.add("night-layer-disable")
            viirs.set("visible",false);
          }else if (element.classList.contains("night-layer-disable")) {
            viirs.set("visible",true);
            element.classList.remove("night-layer-disable")
            element.classList.add("night-layer-enable")
          }

        },false);

      };
      ol.inherits(showTessLayerControl, ol.control.Control);

      var view = new ol.View({
        projection: ol.proj.get("EPSG:4326"),
        extent: [-180, -90, 180, 90],
        center: [0,0],
        zoom: 2
      }),


      //load VIIRS help map
      map = new ol.Map({
        target: 'map',
        controls: [new showTessLayerControl],
        layers: [
          osm,viirs,tess
        ],
        view: view,
        loadTilesWhileAnimating: true
      });

      //Add popup element

      var element = document.getElementById('popup');

      var popup = new ol.Overlay({
        element: element,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -50]
      });
      map.addOverlay(popup);


      $(element).popover({
        placement:'auto',
        html: true,
        content:'<div id="tess_name">name</div><div><canvas width="350px" height="60px" id="cv"></canvas></div>'
      });

      //draw_color_range();
     // display popup on click

      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
          function(feature) {
            return feature;
          });
        if (feature) {
          var coordinates = feature.getGeometry().getCoordinates();
          popup.setPosition(coordinates);

          //draw_magnitude(feature.get('mag'));

          //var popup_string = $(element).data('bs.popover').options.content;

          //$(element).data('bs.popover').options.content = "<h3>"+feature.get('name')+"</h3><div><canvas width='350' height='60' id='cv'></canvas></div>";
          //draw_color_range();
          //draw_magnitude(feature.get('mag'));


          $(element).popover('show');
          draw_magnitude(feature.get('mag'));
          document.getElementById("tess_name").innerHTML = feature.get('name');

        } else {
          $(element).popover('hide');
        }
      });

      // get the pixel position with every move
      var mousePosition = null;

      container.addEventListener('mousemove', function(event) {
        mousePosition = map.getEventPixel(event);
        map.render();
      });

      container.addEventListener('mouseout', function() {
        mousePosition = null;
        map.render();
      });

      // before rendering the layer, do some clipping
      viirs.on('precompose', function(event) {
        var ctx = event.context;
        var pixelRatio = event.frameState.pixelRatio;
        ctx.save();
        ctx.beginPath();
        if (mousePosition) {
          // only show a circle around the mouse
          ctx.arc(mousePosition[0] * pixelRatio, mousePosition[1] * pixelRatio,
            radius * pixelRatio, 0, 2 * Math.PI);
          ctx.lineWidth = 5 * pixelRatio;
          ctx.strokeStyle = 'rgba(0,0,0,0.5)';
          ctx.stroke();
        }
        ctx.clip();
      });

      // after rendering the layer, restore the canvas context
      viirs.on('postcompose', function(event) {
        var ctx = event.context;
        ctx.restore();
      });

      $('.ol-rotate-reset, .ol-attribution button[title]').tooltip({
        placement: 'left'
      });

      readJson("lpm-2019-03.json");


      function readJson(file) {

        var xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var myObj = JSON.parse(this.responseText);




              tess_source = tess.getSource();

              tess_source.clear();


              for (var i = 0; i < myObj.length; i++){
                  tessFeature = new ol.Feature({
                    geometry: new ol.geom.Point([myObj[i]["longitude"], myObj[i]["latitude"]]),
                    name: myObj[i]["name"],
                    mag: myObj[i]["mag_avg"]
                  });
                tessFeature.setStyle(iconStyle);

                tess_source.addFeature(tessFeature);



              }


            }
        };
        xmlhttp.open("GET", file, true);
        xmlhttp.send();
      }

    </script>
  </body>
</html>
